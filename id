from telethon.tl.functions.users import GetFullUserRequest
from telethon.tl.types import Message

from .. import loader, utils


@loader.tds
class InfoArtom(loader.Module):
    """Retrieve information about bot/user/chat"""

    strings = {
        "name": "Info",
        "loading": "ğŸ’  <b>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ¸Ğ½Ñ„Ñƒ...</b>",
        "not_chat": "âŒ <b>Ğ®Ğ·ĞµÑ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½</b>",
    }
    async def client_ready(self, client, db):
        if not self.db.get('ModArtInfo', 'Chat'):
            self.db.set('ModArtInfo', 'Chat', [])

    async def getchatcmd(self, message: Message):
        a = self.db.get('ModArtInfo', 'Chat', [])
        chat_id =  str(utils.get_chat_id(message))
        chat_idd =  str(utils.get_chat_title(message))
        if chat_id in a:
            a.remove(chat_id)
            await utils.answer(message, f'ğŸ­Ğ§Ğ°Ñ‚ {chat_idd} ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ¸Ğ· Ğ±Ğ´')
        else:
            a.append(chat_id)
            await utils.answer(message, f'ğŸ­Ğ§Ğ°Ñ‚ {chat_idd} Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ±Ğ´')
            self.db.set('ModArtInfo', 'Chat', a)

    async def watcher(self, message: Message):
        """Get object infomation"""
        args = utils.get_args_raw(message)
        reply = await message.get_reply_message()
        text = message.text.lower()
        if str(utils.get_chat_id(message)) not in self.db.get('ModArtInfo', 'Chat'):
            return
        if not text.startswith('Ğ˜Ğ´'.lower()) and not text.startswith('Ğ¸Ğ´'.lower()) and not text.startswith('Ğ˜Ğ”'.lower()):
            return
        message = await utils.answer(message, self.strings("loading"))

        try:
            user_id = (
                (
                    (
                        await self._client.get_entity(
                            args if not args.isdigit() else int(args)
                        )
                    ).id
                )
                if args
                else reply.sender_id
            )
        except Exception:
            user_id = self._tg_id

        user = await self._client(GetFullUserRequest(user_id))

        user_ent = user.users[0]

        photo = await self._client.download_profile_photo(user_ent.id, bytes)

        user_info = (
            f"<b>ğŸ­Name:</b> {user_ent.first_name or 'âŒ'}\n"
            f"<b>ğŸš€Username:</b> @{user_ent.username or 'âŒ'}\n"
            f"<b>ğŸŒ—USER:</b> <code>#user{user_ent.id}</code>\n"
            f"<b>ğŸ†”:</b> <code>{user_ent.id}</code>\n"
            f"<b>ğŸ”°ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°:</b> <code>/banid {user_ent.id}</code>\n"

        )
        await utils.answer(
            message,
            user_info,
               reply_to=reply.id if reply else None,
               link_preview=False,
           )
    
